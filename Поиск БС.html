<!DOCTYPE html>
<html lang="ru">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Поиск БС по CID</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
	<script type="text/javascript"
		src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=zTqplVh_OTS4-AIdMYfODgL6ZLKi-H4pJXyceOYK8WRTBb7Lm-L2uy8TcFpBbfRLGbZQYBT_Fnd7eNStXseG9KWvOOggeGwu1A5eaYgZgQP_iM86draGS3B5XXEXhjHrO0EoPAe5NAFXPFfMeXpW0Glw1M22CO0uH9q8l5epjmd3lwb8kF47ISq2MLNIV5RyL9Xc-n-HDVxOE8tpUUWVx30DVz1PYSOE-zZbrqwGwHKfXeM5Ijmy4mVk6yFqO-DTFRjuU6Rg-rhtKLdAgwOlW4GKDbtcSrot2hNC-K95_9i1X-B2u__74-_onr6jzC2THepRNKHUhL96htBLxOyAchIe7LXA4IlYtO6h-ETwPyJhBrI8T1my1xE9LDDdfv_AYGgT81vE2JcXlrRH7Duws9gclgKQ1DUo555aQ6liDJ41-UtDCvBwBHn_B6Xv-iB72j9YLKegvp5c66C69E6U1--rXqEA5AMNNE0adM4-iNrDA3rfNmQrfDwpfAeCveYRvDWSqDj7CMm3nXhNKawiCpfAR_4S3GOGk532-xFErkJWlv42v71ei3BY0J7Ug7ym3AAbqmtXpKfhEnby4ySfzhJKe-OLADxR7t10tjc5a-qmTsNxDvqJvRYxpseZzeHaGEGRb88cOzOwYyF3-ZesYBLBRk1rDfApmefy2sPHPTrodXU2sGC_-4sAS03ttUBmrvM2KpXaoiCLkOJ5lYj2lTW51_lSnr4ib5bjGrKZVWRcLszzJMIRdDxkZp128i37O8_upV71fj26YbvKPNfYIXPza3YyfIs0IOGMXoskmxxNBjAY1vbVnlE08qBl8NM5WMmtnBnwR95njgp7A_TqhVARj9Tr609Pr-VKETbNxh3aFx9RkWq5h4q-PiY0jaiN"
		charset="UTF-8"></script>
	<style>
		#map {
			height: 600px;
			width: 100%;
		}
	</style>
</head>

<body>
	<h1>Выберите оператора сотовой связи</h1>
	<input type="file" id="fileInput" accept=".xlsx" />
	<br>
	<input type="text" id="cidInput" placeholder="Введите CID" />
	<br>
	<input type="number" id="lengthInput" placeholder="Длина линий (м)" value="500" />
	<button id="searchBtn">Поиск</button>
	<br>
	<div id="map"></div>

	<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
	<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
	<script>
		let data = [];
        let map;

        // Обработчик загрузки файла
        document.getElementById('fileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const dataBin = new Uint8Array(e.target.result);
                const workbook = XLSX.read(dataBin, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                data = XLSX.utils.sheet_to_json(worksheet);
                alert('Базовые станции успешно загружены!');
            };
            reader.readAsArrayBuffer(file);
        });

        // Обработчик поиска
        document.getElementById('searchBtn').addEventListener('click', () => {
            const cidValue = document.getElementById('cidInput').value.trim();
            const lengthValue = parseFloat(document.getElementById('lengthInput').value);
            const result = data.find(row => row.CID === cidValue);

            if (result) {
                const { Широта, Долгота, CID, Азимут } = result;

                // Проверка значений широты, долготы и азимута
                if (isNaN(Широта) || isNaN(Долгота) || isNaN(Азимут)) {
                    alert('Ошибка: неверные координаты или азимут.');
                    return;
                }

                // Проверка на корректность введенной длины
                if (isNaN(lengthValue) || lengthValue <= 0) {
                    alert('Ошибка: длина должна быть положительным числом.');
                    return;
                }

                const azimuth1 = (parseFloat(Азимут) + 60) % 360; // Азимут первой линии
                const azimuth2 = (parseFloat(Азимут) - 60 + 360) % 360; // Азимут второй линии
                const azimuth3 = (parseFloat(Азимут) - 15 + 360) % 360; // Азимут третьей линии
                const azimuth4 = (parseFloat(Азимут) + 15) % 360; // Азимут четвертой линии
                const azimuth5 = (parseFloat(Азимут) - 30 + 360) % 360; // Азимут пятой линии
                const azimuth6 = (parseFloat(Азимут) + 30) % 360; // Азимут шестой линии
                const azimuth7 = (parseFloat(Азимут) - 45 + 360) % 360; // Азимут седьмой линии
                const azimuth8 = (parseFloat(Азимут) + 45) % 360; // Азимут восьмой линии

                const endPoint1 = calculateEndPoint(Широта, Долгота, lengthValue, azimuth1);
                const endPoint2 = calculateEndPoint(Широта, Долгота, lengthValue, azimuth2);
                const endPoint3 = calculateEndPoint(Широта, Долгота, lengthValue, azimuth3);
                const endPoint4 = calculateEndPoint(Широта, Долгота, lengthValue, azimuth4);
                const endPoint5 = calculateEndPoint(Широта, Долгота, lengthValue, azimuth5);
                const endPoint6 = calculateEndPoint(Широта, Долгота, lengthValue, azimuth6);
                const endPoint7 = calculateEndPoint(Широта, Долгота, lengthValue, azimuth7);
                const endPoint8 = calculateEndPoint(Широта, Долгота, lengthValue, azimuth8);

                showMap(Широта, Долгота, CID, endPoint1, endPoint2, endPoint3, endPoint4, endPoint5, endPoint6, endPoint7, endPoint8);
            } else {
                alert('CID не найден.');
            }
        });

        // Функция для отображения карты, линий и заливки
        function showMap(latitude, longitude, cid, endPoint1, endPoint2, endPoint3, endPoint4, endPoint5, endPoint6, endPoint7, endPoint8) {
    // Инициализация карты
    if (!map) {
        map = L.map('map').setView([latitude, longitude], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);
    } else {
        map.setView([latitude, longitude], 14); // Обновляем позицию карты
    }

    // Удаляем предыдущие маркеры и линии
    map.eachLayer((layer) => {
        if (layer instanceof L.Marker || layer instanceof L.Polyline || layer instanceof L.Polygon) {
            map.removeLayer(layer);
        }
    });

    // Создаем круглый маркер с заданной толщиной обводки
    const circleMarker = L.circleMarker([latitude, longitude], {
        color: 'red',
        fillColor: 'red',
        fillOpacity: 0.3,
        radius: 5,
        weight: 1
    }).addTo(map)
    .bindPopup(cid);

    // Рисуем только линии 1 и 2
    L.polyline([[latitude, longitude], [endPoint1.latitude, endPoint1.longitude]], { color: 'blue', weight: 0.5 }).addTo(map);
    L.polyline([[latitude, longitude], [endPoint2.latitude, endPoint2.longitude]], { color: 'blue', weight: 0.5 }).addTo(map);

    // Добавление заливки между линиями 1 и 8
    const polygon1 = L.polygon([
        [latitude, longitude],
        [endPoint1.latitude, endPoint1.longitude],
        [endPoint8.latitude, endPoint8.longitude]
    ], {
        color: 'blue',
        fillColor: 'blue',
        fillOpacity: 0.15,
        weight: 0
    }).addTo(map);

    // Добавление заливки между линиями 2 и 7
    const polygon2 = L.polygon([
        [latitude, longitude],
        [endPoint2.latitude, endPoint2.longitude],
        [endPoint7.latitude, endPoint7.longitude]
    ], {
        color: 'blue',
        fillColor: 'blue',
        fillOpacity: 0.15,
        weight: 0
    }).addTo(map);

    // Добавление заливки между линиями 3 и 4
    const polygon3 = L.polygon([
        [latitude, longitude],
        [endPoint3.latitude, endPoint3.longitude],
        [endPoint4.latitude, endPoint4.longitude]
    ], {
        color: 'blue',
        fillColor: 'blue',
        fillOpacity: 0.15,
        weight: 0
    }).addTo(map);

    // Добавление заливки между линиями 3 и 5
    const polygon4 = L.polygon([
        [latitude, longitude],
        [endPoint3.latitude, endPoint3.longitude],
        [endPoint5.latitude, endPoint5.longitude]
    ], {
        color: 'blue',
        fillColor: 'blue',
        fillOpacity: 0.15,
        weight: 0
    }).addTo(map);

     // Добавление заливки между линиями 4 и 6
    const polygon5 = L.polygon([
        [latitude, longitude],
        [endPoint4.latitude, endPoint4.longitude],
        [endPoint6.latitude, endPoint6.longitude]
    ], {
        color: 'blue',
        fillColor: 'blue',
        fillOpacity: 0.15,
        weight: 0
    }).addTo(map);

     // Добавление заливки между линиями 5 и 7
    const polygon6 = L.polygon([
        [latitude, longitude],
        [endPoint5.latitude, endPoint5.longitude],
        [endPoint7.latitude, endPoint7.longitude]
    ], {
        color: 'blue',
        fillColor: 'blue',
        fillOpacity: 0.15,
        weight: 0
    }).addTo(map);

     // Добавление заливки между линиями 6 и 8
    const polygon7 = L.polygon([
        [latitude, longitude],
        [endPoint6.latitude, endPoint6.longitude],
        [endPoint8.latitude, endPoint8.longitude]
    ], {
        color: 'blue',
        fillColor: 'blue',
        fillOpacity: 0.15,
        weight: 0
    }).addTo(map);
    
}
        
        

        // Функция для вычисления конечной точки
        function calculateEndPoint(lat, lng, distance, azimuth) {
            const R = 6371000; // Радиус Земли в метрах
            const δ = distance / R; // Дистанция в радианах
            const θ = azimuth * Math.PI / 180; // Преобразование азимута в радианы

            const lat1 = lat * Math.PI / 180; // Преобразование широты в радианы
            const lon1 = lng * Math.PI / 180; // Преобразование долготы в радианы

            const lat2 = Math.asin(Math.sin(lat1) * Math.cos(δ) + Math.cos(lat1) * Math.sin(δ) * Math.cos(θ));
            const lon2 = lon1 + Math.atan2(Math.sin(θ) * Math.sin(δ) * Math.cos(lat1), Math.cos(δ) - Math.sin(lat1) * Math.sin(lat2));

            return { latitude: lat2 * 180 / Math.PI, longitude: lon2 * 180 / Math.PI };
        }
	</script>
</body>

</html>